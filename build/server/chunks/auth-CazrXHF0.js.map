{"version":3,"file":"auth-CazrXHF0.js","sources":["../../../.svelte-kit/adapter-node/chunks/auth.js"],"sourcesContent":["import { eq } from \"drizzle-orm\";\nimport { sha256 } from \"@oslojs/crypto/sha2\";\nimport { encodeBase64url, encodeHexLowerCase } from \"@oslojs/encoding\";\nimport { drizzle } from \"drizzle-orm/mysql2\";\nimport mysql from \"mysql2/promise\";\nimport { mysqlTable, varchar, int, datetime, timestamp, text } from \"drizzle-orm/mysql-core\";\nimport { d as private_env } from \"./shared-server.js\";\nconst user = mysqlTable(\"user\", {\n  id: varchar(\"id\", { length: 255 }).primaryKey(),\n  age: int(\"age\"),\n  username: varchar(\"username\", { length: 32 }).notNull().unique(),\n  passwordHash: varchar(\"password_hash\", { length: 255 }).notNull()\n});\nconst session = mysqlTable(\"session\", {\n  id: varchar(\"id\", { length: 255 }).primaryKey(),\n  userId: varchar(\"user_id\", { length: 255 }).notNull().references(() => user.id),\n  expiresAt: datetime(\"expires_at\").notNull()\n});\nconst patients = mysqlTable(\"patients\", {\n  id: int(\"id\").primaryKey().autoincrement(),\n  firstName: varchar(\"first_name\", { length: 100 }).notNull(),\n  lastName: varchar(\"last_name\", { length: 100 }).notNull(),\n  email: varchar(\"email\", { length: 255 }).unique(),\n  phone: varchar(\"phone\", { length: 20 }),\n  dateOfBirth: timestamp(\"date_of_birth\"),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\nconst appointments = mysqlTable(\"appointments\", {\n  id: int(\"id\").primaryKey().autoincrement(),\n  patientId: int(\"patient_id\").notNull().references(() => patients.id, { onDelete: \"cascade\" }),\n  doctorId: int(\"doctor_id\").notNull().references(() => doctors.id, { onDelete: \"cascade\" }),\n  appointmentDate: timestamp(\"appointment_date\").notNull(),\n  status: varchar(\"status\", { length: 32 }).default(\"scheduled\"),\n  // e.g., scheduled, completed, cancelled\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\nconst doctors = mysqlTable(\"doctors\", {\n  id: int(\"id\").primaryKey().autoincrement(),\n  firstName: varchar(\"first_name\", { length: 100 }).notNull(),\n  lastName: varchar(\"last_name\", { length: 100 }).notNull(),\n  specialty: varchar(\"specialty\", { length: 100 }),\n  email: varchar(\"email\", { length: 255 }).unique(),\n  phone: varchar(\"phone\", { length: 20 }),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\nconst prescriptions = mysqlTable(\"prescriptions\", {\n  id: int(\"id\").primaryKey().autoincrement(),\n  appointmentId: int(\"appointment_id\").notNull().references(() => appointments.id, { onDelete: \"cascade\" }),\n  medication: text(\"medication\").notNull(),\n  dosage: text(\"dosage\").notNull(),\n  instructions: text(\"instructions\"),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\nconst medicalRecords = mysqlTable(\"medical_records\", {\n  id: int(\"id\").primaryKey().autoincrement(),\n  patientId: int(\"patient_id\").notNull().references(() => patients.id, { onDelete: \"cascade\" }),\n  recordDate: timestamp(\"record_date\").notNull(),\n  description: text(\"description\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\nconst invoices = mysqlTable(\"invoices\", {\n  id: int(\"id\").primaryKey().autoincrement(),\n  patientId: int(\"patient_id\").notNull().references(() => patients.id, { onDelete: \"cascade\" }),\n  appointmentId: int(\"appointment_id\").references(() => appointments.id, { onDelete: \"set null\" }),\n  amount: int(\"amount\").notNull(),\n  status: varchar(\"status\", { length: 32 }).default(\"unpaid\"),\n  // e.g., unpaid, paid, cancelled\n  issuedAt: timestamp(\"issued_at\").defaultNow(),\n  dueAt: timestamp(\"due_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\nconst schema = /* @__PURE__ */ Object.freeze(/* @__PURE__ */ Object.defineProperty({\n  __proto__: null,\n  appointments,\n  doctors,\n  invoices,\n  medicalRecords,\n  patients,\n  prescriptions,\n  session,\n  user\n}, Symbol.toStringTag, { value: \"Module\" }));\nif (!private_env.DATABASE_URL) throw new Error(\"DATABASE_URL is not set\");\nconst client = mysql.createPool(private_env.DATABASE_URL);\nconst db = drizzle(client, { schema, mode: \"default\" });\nconst DAY_IN_MS = 1e3 * 60 * 60 * 24;\nconst sessionCookieName = \"auth-session\";\nfunction generateSessionToken() {\n  const bytes = crypto.getRandomValues(new Uint8Array(18));\n  const token = encodeBase64url(bytes);\n  return token;\n}\nasync function createSession(token, userId) {\n  const sessionId = encodeHexLowerCase(sha256(new TextEncoder().encode(token)));\n  const session$1 = {\n    id: sessionId,\n    userId,\n    expiresAt: new Date(Date.now() + DAY_IN_MS * 30)\n  };\n  await db.insert(session).values(session$1);\n  return session$1;\n}\nasync function validateSessionToken(token) {\n  const sessionId = encodeHexLowerCase(sha256(new TextEncoder().encode(token)));\n  const [result] = await db.select({\n    // Adjust user table here to tweak returned data\n    user: { id: user.id, username: user.username },\n    session\n  }).from(session).innerJoin(user, eq(session.userId, user.id)).where(eq(session.id, sessionId));\n  if (!result) {\n    return { session: null, user: null };\n  }\n  const { session: session$1, user: user$1 } = result;\n  const sessionExpired = Date.now() >= session$1.expiresAt.getTime();\n  if (sessionExpired) {\n    await db.delete(session).where(eq(session.id, session$1.id));\n    return { session: null, user: null };\n  }\n  const renewSession = Date.now() >= session$1.expiresAt.getTime() - DAY_IN_MS * 15;\n  if (renewSession) {\n    session$1.expiresAt = new Date(Date.now() + DAY_IN_MS * 30);\n    await db.update(session).set({ expiresAt: session$1.expiresAt }).where(eq(session.id, session$1.id));\n  }\n  return { session: session$1, user: user$1 };\n}\nasync function invalidateSession(sessionId) {\n  await db.delete(session).where(eq(session.id, sessionId));\n}\nfunction setSessionTokenCookie(event, token, expiresAt) {\n  event.cookies.set(sessionCookieName, token, {\n    expires: expiresAt,\n    path: \"/\"\n  });\n}\nfunction deleteSessionTokenCookie(event) {\n  event.cookies.delete(sessionCookieName, {\n    path: \"/\"\n  });\n}\nexport {\n  db as a,\n  sessionCookieName as b,\n  createSession as c,\n  deleteSessionTokenCookie as d,\n  generateSessionToken as g,\n  invalidateSession as i,\n  setSessionTokenCookie as s,\n  user as u,\n  validateSessionToken as v\n};\n"],"names":[],"mappings":"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"}